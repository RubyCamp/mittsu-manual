<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<title>メッシュ（物体） - Ruby合宿2022春・Mittsuライブラリマニュアル</title><meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=https://rubycamp.github.io/mittsu-manual/favicon.png>
<link rel=stylesheet href=https://rubycamp.github.io/mittsu-manual/css/style.min.6719d72e323121369d5caeb4264b95d8a63cf1deaab029da67602fe5a046e0a4.css>
</head><body class="page page-default-single">
<div id=main-menu-mobile class=main-menu-mobile>
<ul>
<li class=menu-item-home>
<a href=https://rubycamp.github.io/mittsu-manual/>
<span>Home</span>
</a>
</li><li class=menu-item-リファレンスガイド>
<a href=https://rubycamp.github.io/mittsu-manual/docs/>
<span>リファレンスガイド</span>
</a>
</li></ul></div><div class=wrapper>
<div class=header>
<div class=container>
<div class=logo>
<a href=https://rubycamp.github.io/mittsu-manual><img alt=Logo src=https://rubycamp.github.io/mittsu-manual/images/logo.svg></a>
</div><div class=logo-mobile>
<a href=https://rubycamp.github.io/mittsu-manual><img alt=Logo src=https://rubycamp.github.io/mittsu-manual/images/logo-mobile.svg></a>
</div><div id=main-menu class=main-menu>
<ul>
<li class=menu-item-home>
<a href=https://rubycamp.github.io/mittsu-manual/>
<span>Home</span>
</a>
</li><li class=menu-item-リファレンスガイド>
<a href=https://rubycamp.github.io/mittsu-manual/docs/>
<span>リファレンスガイド</span>
</a>
</li></ul></div><button id=toggle-main-menu-mobile class="hamburger hamburger--slider" type=button>
<span class=hamburger-box>
<span class=hamburger-inner></span>
</span>
</button>
</div></div><div class="container pt-2 pt-md-6 pb-3 pb-md-6">
<div class=row>
<div class="col-12 col-md-3 mb-3">
<div class=sidebar>
<div class=docs-menu>
<h4>Docs</h4><ul>
<li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/1000_install/>インストール</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/1100_quick_start/>クイックスタートガイド</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/1150_scene/>Sceneクラス</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/1200_object_3d/>Object3Dクラス</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/3000_renderer/>Rendererクラス</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/4000_geometry/>ジオメトリ（形状）</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/5000_material/>マテリアル（質感）</a>
</li><li class=active>
<a href=https://rubycamp.github.io/mittsu-manual/docs/6000_mesh/>メッシュ（物体）</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/6500_light/>ライト</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/7000_camera/>カメラ</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/8000_events/>イベント</a>
</li><li>
<a href=https://rubycamp.github.io/mittsu-manual/docs/10000_collision/>当たり判定について</a>
</li></ul></div></div></div><div class="col-12 col-md-9">
<h1 class=title>メッシュ（物体）</h1><div class=content>
<h2 id=メッシュmeshとは>メッシュ（Mesh）とは</h2><p>メッシュとは、これまで説明してきた「ジオメトリ」（形状）と「マテリアル」（質感）
に基づいて、3次元空間に実際に「位置」を伴って配置されるオブジェクトになります。</p><p>メッシュ（Mesh）クラスはObject3dクラスの子クラスであり、Object3dが持つ全てのメソッドが利用可能です。</p><p>基本的なメッシュの作り方は、これまでも何度か出てきたように、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>geometry</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>SphereGeometry</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>material</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>MeshBasicMaterial</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>color</span><span class=p>:</span> <span class=mh>0xff0000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geometry</span><span class=p>,</span> <span class=n>material</span><span class=p>)</span>
</span></span></code></pre></div><p>という形式が一般的です。
ジオメトリ・マテリアルの生成はそれぞれ作りたい物体に応じて適宜変更されますが、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>mesh</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geometry</span><span class=p>,</span> <span class=n>material</span><span class=p>)</span>
</span></span></code></pre></div><p>の部分が変わることは無いでしょう。</p><p>上記のように作成されたメッシュは、最終的に、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>mesh</span><span class=p>)</span>
</span></span></code></pre></div><p>のように、シーンオブジェクトに追加されることで、3次元空間に登録されカメラによる撮影対象に加わります。</p><p>なお、生成されたばかりのメッシュ（カメラもですが）オブジェクトの初期位置は、
ワールド座標系の原点（[0, 0, 0]）になります。</p><p>すなわち、単純に生成して追加しただけだと、カメラもメッシュも同一座標に重なって登録されてしまう
ことになります。</p><p>これでは実行しても何も表示されませんので、カメラかメッシュのどちらかの位置を変更しなければなりません。</p><p>カメラの初期状態における向きは、-Z方向になります。</p><p>つまり、カメラは-Z方向に向いてワールド座標の原点に位置しているわけですので、
最も少ないコードでメッシュをカメラの撮影範囲に移動するとすれば、ワールド座標系において、-Z方向に
数単位ほど移動させればよさそうですね。</p><figure class=center><img src=https://rubycamp.github.io/mittsu-manual/images/2000_scene/fig_2.png width=640 height=480>
</figure><p>上図のように、-Z方向に5単位ほど移動させるコードは、以下のように記述できます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>mesh</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=mi>5</span>
</span></span></code></pre></div><p>このコードは、前述の「scene.add(mesh)」の前に書いても後に書いても、どちらでも問題ありません。</p><p>実行結果は以下のようになります。</p><figure class=center><img src=https://rubycamp.github.io/mittsu-manual/images/6000_mesh/fig_1.png width=640 height=480>
</figure><p>後は、同じ理屈でX軸方向やY軸方向も含めて、好きな位置にメッシュを移動させることができます。</p><h5 id=アニメーション>アニメーション</h5><p>アニメーションといっても、キャラクタが生き物のように動くようなものは現時点（2022/02月）の
Mittsuのバージョンでは非常に困難です。</p><p>そのため、Ruby合宿2022では、いわゆる「ボーン・アニメーション」のような複雑なアニメーションは
扱いません。</p><p>ここまで紹介してきた基本的なジオメトリ・マテリアルを用いたメッシュ全体の位置や回転・サイズ
などを変化させることでアニメーションを表現していきましょう。</p><p>例えば、以下のように、X-Z平面上で真円軌道を描いて運動する球体を表現する
アニメーションはどのように実装すればよいでしょうか？</p><figure class=center><img src=https://rubycamp.github.io/mittsu-manual/images/6000_mesh/fig_2.gif width=640 height=480>
</figure><p>実装例の全文は次のようになります。</p><p>※ 見た目に陰影がついていた方が分かりやすいので、MeshPhongMaterialを用いて陰影を付けています。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;mittsu&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scene</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Scene</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>fog</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Uniform</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>:float</span><span class=p>,</span> <span class=mi>2000</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>camera</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>PerspectiveCamera</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>75</span><span class=o>.</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=o>.</span><span class=mi>333</span><span class=p>,</span> <span class=mi>0</span><span class=o>.</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1000</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>renderer</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>OpenGLRenderer</span><span class=o>.</span><span class=n>new</span> <span class=ss>width</span><span class=p>:</span> <span class=mi>800</span><span class=p>,</span> <span class=ss>height</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span> <span class=ss>title</span><span class=p>:</span> <span class=s1>&#39;RubyCamp 2022&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>directionalLight</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>DirectionalLight</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mh>0xffffff</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>directionalLight</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>directionalLight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>geometry</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>SphereGeometry</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>32</span><span class=p>,</span> <span class=mi>32</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>material</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>MeshPhongMaterial</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>color</span><span class=p>:</span> <span class=mh>0xff0000</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geometry</span><span class=p>,</span> <span class=n>material</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>mesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>theta</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>renderer</span><span class=o>.</span><span class=n>window</span><span class=o>.</span><span class=n>run</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>mesh</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=no>Math</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>mesh</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=no>Math</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>)</span> <span class=o>-</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>  <span class=n>renderer</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>scene</span><span class=p>,</span> <span class=n>camera</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>theta</span> <span class=o>+=</span> <span class=mi>0</span><span class=o>.</span><span class=mo>05</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>これは非常に簡単ですね。</p><p>3次元空間を真上から眺めた座標系（X-Z平面）を考え、
以下のように原点を中心とした半径rの時計回り円運動を考えれば、
任意の角度θにおける（メッシュが取るべき）X座標・Z座標の値「x」「z」は、それぞれ、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>x = r * cos(θ)
</span></span><span class=line><span class=cl>z = r * sin(θ)
</span></span></code></pre></div><p>となるので、後はカメラにちょうどいい感じに収まるよう、-Z方向に半径rより若干大き目にオフセットしてやればよいということになります。</p><figure class=center><img src=https://rubycamp.github.io/mittsu-manual/images/6000_mesh/fig_3.png width=800 height=600>
</figure><p>このように、</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>renderer</span><span class=o>.</span><span class=n>window</span><span class=o>.</span><span class=n>run</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=c1># この辺りでシーン内のオブジェクトの状態を1フレーム分変化させる</span>
</span></span><span class=line><span class=cl>  <span class=n>renderer</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>scene</span><span class=p>,</span> <span class=n>camera</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=c1># この辺りでも可。先にフレームを描画してから変化させる場合はこちら。</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>というメインループの中で、1フレーム毎にシーン内のオブジェクトの状態を微妙に変えていくことで、
アニメーションが表現可能となります。</p><h2 id=メッシュのグルーピング>メッシュのグルーピング</h2><p>複数のメッシュを言わば「くっつけ」て、一つのメッシュのように扱うことも可能です。</p><p>例えば、以下のように立方体に円錐を横方向に結合させた物体を作ってみましょう。</p><figure class=center><img src=https://rubycamp.github.io/mittsu-manual/images/6000_mesh/fig_4.png width=800 height=600>
</figure><h6 id=親オブジェクトの作成>親オブジェクトの作成</h6><p>まず、シンプルに緑色をした立方体のメッシュを作成します。</p><p>このメッシュを「mesh_body」と名付けます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>geom_body</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>BoxGeometry</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mat_body</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>MeshLambertMaterial</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>color</span><span class=p>:</span> <span class=mh>0x00ff00</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh_body</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geom_body</span><span class=p>,</span> <span class=n>mat_body</span><span class=p>)</span>
</span></span></code></pre></div><h6 id=子オブジェクトの作成>子オブジェクトの作成</h6><p>そして、続いて青色をした円錐のメッシュを作成します。</p><p>円錐は、立方体の1面の中に収めたいので、半径を0.5としています
（長さについては適当ですが、とりあえず0.5としましょう）。</p><p>このメッシュを「mesh_lenz」と名付けましょう（何となく、ビデオカメラのような感じの見た目を作るため）。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>geom_lenz</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>CylinderGeometry</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=p>,</span> <span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=p>,</span> <span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mat_lenz</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>MeshLambertMaterial</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>color</span><span class=p>:</span> <span class=mh>0x0000ff</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh_lenz</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geom_lenz</span><span class=p>,</span> <span class=n>mat_lenz</span><span class=p>)</span>
</span></span></code></pre></div><h6 id=オブジェクトの親子関係の設定>オブジェクトの親子関係の設定</h6><p>こうして作成した2つのメッシュを、立方体の方を親として、入れ子関係にします。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>mesh_body</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>mesh_lenz</span><span class=p>)</span>
</span></span></code></pre></div><p>これにより、mesh_lenzはmesh_bodyの子オブジェクト（child）となり、
親のワールド座標系の変化に追随するようになります。</p><h6 id=親オブジェクトをシーンに登録>親オブジェクトをシーンに登録</h6><p>そして、親子関係を設定したmesh_bodyを、シーンに追加します。</p><p>ついでに、原点に置いたカメラに映るよう、mesh_bodyの位置を-Z方向に若干ずらしておきましょう。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>mesh_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh_body</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=mi>5</span>
</span></span></code></pre></div><h6 id=子オブジェクトが従う座標系>子オブジェクトが従う座標系</h6><p>しかし、これだけでは実行しても立方体が表示されるのみです。</p><p>これは、少々直感的に把握しづらいかも知れませんが、mesh_bodyのchildになったmesh_lenzが、
mesh_bodyのローカル座標系における原点に位置している…つまり、mesh_bodyと完全に重なっているためです。</p><p>mesh_lenzはmesh_bodyより小さく作っていますので、これではmesh_bodyの中に埋もれてしまいます。</p><p>以下のようにして、mesh_bodyの一面に（横向きに）張り付くように移動させてみましょう。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>mesh_lenz</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=o>-</span><span class=mi>0</span><span class=o>.</span><span class=mi>5</span>          <span class=c1># -X方向に0.5移動（高さを0.5にしているため）</span>
</span></span><span class=line><span class=cl><span class=n>mesh_lenz</span><span class=o>.</span><span class=n>rotation</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=no>Math</span><span class=o>::</span><span class=no>PI</span> <span class=o>/</span> <span class=mi>2</span>  <span class=c1># Z軸を中心にπ/2（90度）回転</span>
</span></span></code></pre></div><p>これで、前述の図のような形状に変化します。</p><p>ここでポイントとなるのは、mesh_bodyの子（child）となったmesh_lenzが属している座標系です。</p><p>mesh_lenzは、上記の通りシーン全体のワールド座標ではなく、mesh_bodyのローカル座標に基づいて移動や回転していることが見て取れます。</p><p>このように、あるオブジェクトに入れ子になった子オブジェクトは、親のローカル座標系に基づいて移動・回転・スケールするようになります。</p><p>そして、親であるmesh_bodyが何故ワールド座標に従うかと言えば、これも同じ理屈で、mesh_bodyから見た親オブジェクトが
シーン（scene）そのものになるためです。</p><p>つまり、ワールド座標とは、シーンオブジェクトのローカル座標系と言い換えることもできるわけです。</p><h6 id=結合したまま扱えることの確認>結合したまま扱えることの確認</h6><p>最後に、親オブジェクトであるmesh_bodyだけを移動させ、子オブジェクトが相対的な位置関係を保ったまま追随することを確認しましょう。</p><p>以下のコードで、mesh_bodyを円周軌道で周回させつつ、X・Y軸に沿って回転させてみます。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>theta</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>renderer</span><span class=o>.</span><span class=n>window</span><span class=o>.</span><span class=n>run</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>mesh_body</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=no>Math</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>mesh_body</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=no>Math</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>)</span> <span class=o>-</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>  <span class=n>mesh_body</span><span class=o>.</span><span class=n>rotate_x</span><span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mo>05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>mesh_body</span><span class=o>.</span><span class=n>rotate_y</span><span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mo>05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>renderer</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>scene</span><span class=p>,</span> <span class=n>camera</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>theta</span> <span class=o>+=</span> <span class=mi>0</span><span class=o>.</span><span class=mo>03</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>実行すると以下のように挙動します。</p><figure class=center><img src=https://rubycamp.github.io/mittsu-manual/images/6000_mesh/fig_5.gif width=800 height=600>
</figure><p>親オブジェクトであるmesh_bodyの位置・回転情報が変化しても、子であるmesh_lenzは何もしていないのにちゃんと追随して位置関係を保っていますね。</p><p>もちろん、親オブジェクトを任意に動かしながら、子オブジェクトも動かすこともできます。</p><p>この入れ子構造を活用することで、基本的な形状だけでも結構複雑な物体を表現することができるようになります。</p><h5 id=オブジェクトグループmittsugroupについて>オブジェクトグループ(Mittsu::Group)について</h5><p>前述の例では、普通のメッシュであるmesh_bodyを親として直接シーンに追加しましたが、
複数のオブジェクトをグルーピングする場合、不可視の親オブジェクトを作って、
それに子として関連オブジェクトを紐づけるような使い方をしたいこともあります。</p><p>そんな時に使うのが、Mittsu::Groupクラスになります。</p><p>Mittsu::Groupを使って、本体（mesh_body）とレンズ（mesh_lenz）を備えた「video_camera」オブジェクトを
定義するよう、前記の例を少し書き換えてみましょう。</p><p>以下がその全文になります。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-ruby data-lang=ruby><span class=line><span class=cl><span class=nb>require</span> <span class=s1>&#39;mittsu&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scene</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Scene</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>fog</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Uniform</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>:float</span><span class=p>,</span> <span class=mi>2000</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>camera</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>PerspectiveCamera</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>75</span><span class=o>.</span><span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=o>.</span><span class=mi>333</span><span class=p>,</span> <span class=mi>0</span><span class=o>.</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1000</span><span class=o>.</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>renderer</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>OpenGLRenderer</span><span class=o>.</span><span class=n>new</span> <span class=ss>width</span><span class=p>:</span> <span class=mi>800</span><span class=p>,</span> <span class=ss>height</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span> <span class=ss>title</span><span class=p>:</span> <span class=s1>&#39;RubyCamp 2022&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>directionalLight</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>DirectionalLight</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mh>0xffffff</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>directionalLight</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>directionalLight</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>geom_body</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>BoxGeometry</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mat_body</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>MeshLambertMaterial</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>color</span><span class=p>:</span> <span class=mh>0x00ff00</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh_body</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geom_body</span><span class=p>,</span> <span class=n>mat_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>geom_lenz</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>CylinderGeometry</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=p>,</span> <span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=p>,</span> <span class=mi>0</span><span class=o>.</span><span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mat_lenz</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>MeshLambertMaterial</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=ss>color</span><span class=p>:</span> <span class=mh>0x0000ff</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh_lenz</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Mesh</span><span class=o>.</span><span class=n>new</span><span class=p>(</span><span class=n>geom_lenz</span><span class=p>,</span> <span class=n>mat_lenz</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>video_camera</span> <span class=o>=</span> <span class=no>Mittsu</span><span class=o>::</span><span class=no>Group</span><span class=o>.</span><span class=n>new</span>
</span></span><span class=line><span class=cl><span class=n>video_camera</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>mesh_body</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>video_camera</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>mesh_lenz</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>scene</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>video_camera</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>video_camera</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=o>-</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>mesh_lenz</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=o>-</span><span class=mi>0</span><span class=o>.</span><span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>mesh_lenz</span><span class=o>.</span><span class=n>rotation</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=no>Math</span><span class=o>::</span><span class=no>PI</span> <span class=o>/</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>r</span> <span class=o>=</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl><span class=n>theta</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>renderer</span><span class=o>.</span><span class=n>window</span><span class=o>.</span><span class=n>run</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=n>video_camera</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=no>Math</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>theta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>video_camera</span><span class=o>.</span><span class=n>position</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=n>r</span> <span class=o>*</span> <span class=no>Math</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>theta</span><span class=p>)</span> <span class=o>-</span> <span class=mi>7</span>
</span></span><span class=line><span class=cl>  <span class=n>video_camera</span><span class=o>.</span><span class=n>rotate_x</span><span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mo>05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>video_camera</span><span class=o>.</span><span class=n>rotate_y</span><span class=p>(</span><span class=mi>0</span><span class=o>.</span><span class=mo>05</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>renderer</span><span class=o>.</span><span class=n>render</span><span class=p>(</span><span class=n>scene</span><span class=p>,</span> <span class=n>camera</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>theta</span> <span class=o>+=</span> <span class=mi>0</span><span class=o>.</span><span class=mo>03</span>
</span></span><span class=line><span class=cl><span class=k>end</span>
</span></span></code></pre></div><p>mesh_bodyを直接シーンに追加するよりも、やや可読性が上がったような気がしますね。</p><p>このように、Mittsu::Groupのインスタンスそのものはレンダリング対象になりませんので、
複数のオブジェクトを束ねる用途に使うと便利です。</p><p>Mittsu::Groupでは、Object3Dクラスを継承しているクラスのインスタンスであれば何でも
追加できますので、メッシュだけではなく光源（ライト）などもまとめることも可能です。</p></div></div></div></div></div></div><div class=sub-footer>
<div class=container>
<div class=row>
<div class=col-12>
<div class=sub-footer-inner>
<ul>
<li class=zerostatic><a href=https://www.zerostatic.io>www.zerostatic.io</a></li></ul></div></div></div></div></div><script type=text/javascript src=https://rubycamp.github.io/mittsu-manual/js/scripts.min.bafc052229b4b40bf03c477d31c5cdd9352ece8afbadf35ab97ed14495098fc9.js></script>
</body></html>